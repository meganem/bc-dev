<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Bloomcase Layout</title>
<link href="style.css" rel="stylesheet" type="text/css" />
<script src="d3.v2.min.js"></script>
<script src="bloomcase_layout.js"></script>
</head>

<body onload="drawBloomcase()">
<div id="modalOptions" style="position:fixed;left:100px;right:200px;background:red;height:100px;width:100px;display:none;">Options!</div>
<h1>Bloomcase Layout</h1>

<svg id="timeline">
</svg>
<div id="info">
</div>

<script>
function drawBloomcase() {
    	var shapeMeasures = {
	    Inspiration: {myWidth: 27, myHeight: 27,
	    pathd: "M24.248,26.755H2.833c-1.404,0-2.548-1.143-2.548-2.548V2.793c0-1.405,1.144-2.548,2.548-2.548h21.415 c1.405,0,2.549,1.143,2.549,2.548v21.414C26.796,25.612,25.653,26.755,24.248,26.755z"                            },
	    Final: {myWidth: 47.4, myHeight: 47.4,
	    pathd: "M47.392,44.295c0,1.709-1.388,3.096-3.097,3.096H3.096C1.386,47.391,0,46.004,0,44.295V3.096 C0,1.386,1.386,0,3.096,0h41.199c1.709,0,3.097,1.386,3.097,3.096V44.295z"
	    },
	    Draft: {myWidth: 35, myHeight: 34.8,
            pathd: "M31.42,34.758H3.341C1.5,34.758,0,33.26,0,31.419V3.341C0,1.499,1.5,0,3.341,0H31.42 c1.843,0,3.342,1.499,3.342,3.341v28.079C34.762,33.26,33.263,34.758,31.42,34.758z"
	    },
	    Sketch: {myWidth: 26.5, myHeight: 26.5,
	    pathd: "M23.963,26.51H2.548C1.143,26.51,0,25.367,0,23.962V2.548C0,1.143,1.143,0,2.548,0h21.415 c1.405,0,2.549,1.143,2.549,2.548v21.414C26.511,25.367,25.368,26.51,23.963,26.51z"
	    },
	    Idea: {myWidth: 33.8, myHeight: 38.6,
	    pathd: "M16.897,0C14.483,7.241,7.241,16.896,0,19.311c7.241,2.414,14.483,12.069,16.897,19.312 c2.414-7.241,9.654-16.896,16.896-19.312C26.551,16.896,19.311,7.241,16.897,0z"
	    }
	}

    newNodes = {};
    testLayout = new d3_layout_bloomcase();
    d3.json("new8.json", function(data) {newNodes = data;
    
    testLayout.nodes(newNodes.nodes);
    
    d3.select("svg").append("g").attr("id", "bloomG");

    d3.select("#bloomG").selectAll("line").data(testLayout.links()).enter().append("line")
    .attr("x1", 30)
    .attr("x2", 30)
    .attr("y1", function(d,i) {return 200 + (d.source.row * 40)})
    .attr("y2", function(d,i) {return 200 + (d.target.row * 40)})
    .style("stroke", "black")
    .style("stroke-width", 2)
    .transition()
    .duration(1000)
    .attr("x1", function(d,i) {return d.source.column * 30})
    .attr("x2", function(d,i) {return d.target.column * 30}) 
    .attr("y1", function(d,i) {return 200 + (d.source.row * 40)})
    .attr("y2", function(d,i) {return 200 + (d.target.row * 40)})


    
    var secG = d3.select("#bloomG").selectAll("g.sec").data(testLayout.nodes()).enter().append("g")
    .attr("width", 20)
    .attr("height", 20)
    .attr("transform", function(d,i) {return "translate(30,"+ (200 + (d.row * 40)) +")"})
    
    secG.append("path")
    .attr("class", function(d){ return d.kind; })
    .attr("d", function(d,i) {return shapeMeasures[d.kind]["pathd"]})
    .attr("transform", function(d) { 
	return "translate(" + (-1*(shapeMeasures[d.kind]["myWidth"]/2)) + "," + (-1*(shapeMeasures[d.kind]["myHeight"]/2)) + ")"; 
    });

    secG.append("text")
                .attr("dx", -1)
                .attr("dy", ".35em")
                .attr("alignment-baseline", "center")
                .attr("text-anchor", "middle")
                .style("fill", "white")
                .text(function(d) { return d.nid });
    
    secG.transition().duration(1000)
    .attr("transform", function(d,i) {return "translate("+ (d.column * 30) +","+ (200 + (d.row * 40)) +")"})
    

    });
    
}


function startMove(d,i) {
    if (!d3.select("#genNode").empty()) {return;}
    var curMouse = d3.mouse(this.parentNode);
    d3.select("#mainSVG").on("mousemove", moveGenNode)
    d3.select("#mainSVG").on("mouseup", endMove)
    d3.select("#mainSVG").append("line")
    .attr("id", "genLine")
    .attr("x1", d.x)
    .attr("y1", d.y)
    .attr("x2", curMouse[0])
    .attr("y2", curMouse[1])
    .style("stroke", "gray")
    .style("stroke-width", 3)
    d3.select("#mainSVG").append("g")
    .attr("id","genNode")
    .on("click", function() {d3.select("#modalOptions").style("display","block");d3.select("#genNode").remove();d3.select("#genLine").remove()})
    .attr("transform","translate("+curMouse[0]+","+curMouse[1]+")").append("circle").attr("r","1").style("fill", "lightgray").style("opacity", 0).transition().duration(300).style("opacity",1).attr("r",20)

}

function endMove(d,i) {
    if (!d3.select(".options").empty()) {return;}

    var curMouse = d3.mouse(this);

    d3.select("#mainSVG").on("mousemove", null)
    
    d3.select("#genNode")
    .append("circle")
    .style("fill", "none")
    .style("stroke", "brown")
    .style("stroke-width", 1)
    .attr("r", 0)
    .transition()
    .duration(500)
    .attr("r", 100)
    
    function pointsOnCircle(shapeType,inc) {
	var circx = 100 * Math.cos(15 * inc);
	var circy = 100 * Math.sin(15 * inc);
	return ((-1*(shapeMeasures[shapeType]["myWidth"]/2)) + circx)+","+(circy + (-1*(shapeMeasures[shapeType]["myHeight"]/2)));
    }
    
    var possibleShapes = ["Inspiration", "Final", "Draft", "Sketch", "Idea"]
    d3.select("#genNode").selectAll("path.options").data(possibleShapes)
    .enter()
    .append("path")
    .attr("class", function(p){ return "options " + p; })
    .attr("d", function(p) {
	return shapeMeasures[p]["pathd"]
    })
    .attr("transform", function(p) { 
		    return "translate(" + (-1*(shapeMeasures[p]["myWidth"]/2)) + "," + (-1*(shapeMeasures[p]["myHeight"]/2)) + ")scale(.1)"; 
    })
    .transition()
    .duration(500)
    .attr("scale",1)
    .attr("transform", function (p,q) {return "translate("+ pointsOnCircle(p,q) + ")scale(1)"})
}

function moveGenNode(d,i) {
    var curMouse = d3.mouse(this);
    d3.select("#genNode")
    .attr("transform","translate("+curMouse[0]+","+curMouse[1]+")")
    
    d3.select("#genLine")
    .attr("x2", curMouse[0])
    .attr("y2", curMouse[1])
    
}

function redraw() {
//    d3.select("#bloomG").attr("transform", "translate("+bloomZoom.translate()[0]+",0)");
}

    </script>
    
    
</body>
</html>
